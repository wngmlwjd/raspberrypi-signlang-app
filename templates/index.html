<script>
const form = document.getElementById("recordForm");
const statusEl = document.getElementById("status");
const videoContainer = document.getElementById("videoContainer");
const videoEl = document.getElementById("recordedVideo");
const videoSource = document.getElementById("videoSource");
const framesContainer = document.getElementById("framesContainer");
const framesDiv = document.getElementById("frames");

// 녹화 버튼 클릭
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "녹화 중...";

    // 영상 초기화
    videoSource.src = "";
    videoContainer.style.display = "none";

    // 프레임 초기화 → 버튼 클릭 시만
    framesDiv.innerHTML = "";
    framesContainer.style.display = "none";

    await fetch("/start_recording", { method: "POST" });
});

// 영상 준비 확인 함수
const waitForVideo = async (url, retries = 10, delay = 500) => {
    for (let i = 0; i < retries; i++) {
        const res = await fetch(url, { method: "HEAD" });
        if (res.ok) return true;
        await new Promise(r => setTimeout(r, delay));
    }
    return false;
};

// 녹화 상태 모니터링
setInterval(async () => {
    const res = await fetch("/recording_status");
    const data = await res.json();
    statusEl.textContent = data.status;

    // 영상 자동 재생 후에 프레임 미리보기 생성
    if (data.status.includes("녹화 및 프레임 추출 완료") && videoContainer.style.display === "none") {
        const videoUrl = `/recorded_video?time=${new Date().getTime()}`;
        const exists = await waitForVideo(videoUrl);
        if (exists) {
            // 1) 영상 재생
            videoSource.src = videoUrl;
            videoContainer.style.display = "block";
            videoEl.load();
            videoEl.play();

            // 2) 프레임 미리보기 생성
            if (data.frame_count > 0) {
                framesContainer.style.display = "block";
                const totalFrames = data.frame_count;
                const displayCount = 5;
                const step = Math.floor(totalFrames / displayCount) || 1;

                for (let i = 0; i < totalFrames && i < displayCount * step; i += step) {
                    const img = document.createElement("img");
                    img.src = `/frames/frame_${i.toString().padStart(5,'0')}.jpg?time=${new Date().getTime()}`;
                    img.width = 120;
                    framesDiv.appendChild(img);
                }
            }
        }
    }
}, 1000);
</script>
